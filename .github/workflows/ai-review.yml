# æª”æ¡ˆåç¨±ï¼š.github/workflows/ai-review.yml

name: AI Code Review

# è§¸ç™¼æ¢ä»¶ï¼šç•¶æœ‰æ–°çš„æˆ–æ›´æ–°çš„ Pull Request é‡å° main åˆ†æ”¯æ™‚
on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize]

# å·¥ä½œæµç¨‹æ¬Šé™
permissions:
  pull-requests: write # ç™¼å¸ƒ/æ›´æ–°è©•è«–éœ€è¦
  issues: read         # è®€å–è©•è«–éœ€è¦
  contents: write      # ã€æ–°å¢ã€‘åˆä½µç¨‹å¼ç¢¼éœ€è¦

jobs:
  ai-review-job:
    runs-on: ubuntu-latest

    steps:
      # æ­¥é©Ÿ 1ï¼šæª¢å‡ºå°ˆæ¡ˆç¨‹å¼ç¢¼
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # æ­¥é©Ÿ 2ï¼šç²å–æœ¬æ¬¡ Pull Request çš„ç¨‹å¼ç¢¼è®Šæ›´å…§å®¹
      - name: Get code diff
        id: get-diff
        run: |
          DIFF=$(git diff --unified=0 ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }})
          
          echo "===== CODE DIFF START ====="
          echo "$DIFF"
          echo "===== CODE DIFF END ====="
          
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # æ­¥é©Ÿ 3ï¼šã€æœ€çµ‚çµ‚æ¥µä¿®æ­£ã€‘å‘¼å« GLM API é€²è¡Œç¨‹å¼ç¢¼å¯©æŸ¥
      - name: Call GLM API for review
        id: call-ai
        if: steps.get-diff.outputs.diff != ''
        run: |
          # ã€é—œéµæ”¹è®Šã€‘ä½¿ç”¨ Here Document å®‰å…¨åœ°å°‡å¤šè¡Œ diff å¯«å…¥æª”æ¡ˆ
          # é€™ç¨®æ–¹æ³•å¯ä»¥å®Œç¾è™•ç†æ‰€æœ‰ç‰¹æ®Šå­—å…ƒå’Œæ›è¡Œç¬¦ï¼Œä¸æœƒç ´å£ Shell èªæ³•
          cat > diff_content.txt << 'EOF'
          ${{ steps.get-diff.outputs.diff }}
          EOF

          # ä½¿ç”¨ jq ä¾†å®‰å…¨åœ°å»ºæ§‹ JSON ä¸¦ç›´æ¥é€éç®¡é“å‚³çµ¦ curl
          RESPONSE=$(jq -n --rawfile diff_content diff_content.txt '
          {
            model: "GLM-4-32B-0414-128K",
            messages: [
              {
                role: "user",
                content: (
                  "ä½ æ˜¯ä¸€ä½è³‡æ·±çš„è»Ÿé«”å·¥ç¨‹å¸«ï¼Œè«‹å¯©æŸ¥ä»¥ä¸‹ç¨‹å¼ç¢¼è®Šæ›´ã€‚\n\n" +
                  "è«‹å¾ä»¥ä¸‹å¹¾é»æä¾›å…·é«”å›é¥‹ï¼š\n" +
                  "1.  **æ½›åœ¨éŒ¯èª¤**ï¼šé‚è¼¯éŒ¯èª¤ã€é‚Šç•Œå•é¡Œç­‰ã€‚\n" +
                  "2.  **ç¨‹å¼ç¢¼å“è³ª**ï¼šå¯è®€æ€§ã€å¯ç¶­è­·æ€§ã€å‘½åè¦ç¯„ã€‚\n" +
                  "3.  **æ•ˆèƒ½å»ºè­°**ï¼šæ˜¯å¦æœ‰æ›´é«˜æ•ˆçš„å¯«æ³•ã€‚\n" +
                  "4.  **å®‰å…¨æ€§**ï¼šæ˜¯å¦æœ‰æ½›åœ¨çš„å®‰å…¨æ¼æ´ã€‚\n\n" +
                  "è«‹ä½¿ç”¨ Markdown æ ¼å¼å›è¦†ï¼Œä¸¦é‡å°å•é¡Œé»çµ¦å‡ºç¨‹å¼ç¢¼ç‰‡æ®µä½œç‚ºèªªæ˜ã€‚\n\n" +
                  "--- ç¨‹å¼ç¢¼è®Šæ›´å…§å®¹ ---\n" +
                  $diff_content +
                  "\n--- ç¨‹å¼ç¢¼è®Šæ›´çµæŸ ---"
                )
              }
            ],
            temperature: 0.3
          }
          ' | curl -s -X POST "https://open.bigmodel.cn/api/paas/v4/chat/completions" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.ZAI_API_KEY2 }}" \
            -d @-)

          echo "===== API RESPONSE START ====="
          echo "$RESPONSE"
          echo "===== API RESPONSE END ====="
          
          if [ -z "$RESPONSE" ]; then
            echo "Error: Empty response from API"
            echo "review<<EOF" >> $GITHUB_OUTPUT
            echo "API èª¿ç”¨å¤±æ•—ï¼šæ”¶åˆ°ç©ºéŸ¿æ‡‰ã€‚è«‹æª¢æŸ¥ API å¯†é‘°å’Œç¶²è·¯é€£æ¥ã€‚" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          REVIEW_TEXT=$(echo "$RESPONSE" | jq -r '.choices[0].message.content' 2>/dev/null)
          
          if [ -z "$REVIEW_TEXT" ] || [ "$REVIEW_TEXT" = "null" ]; then
            echo "Error: Failed to parse API response"
            echo "review<<EOF" >> $GITHUB_OUTPUT
            echo "API éŸ¿æ‡‰è§£æå¤±æ•—ã€‚è©³ç´°çš„åŸå§‹éŸ¿æ‡‰è«‹åƒè€ƒä¸Šæ–¹æ­¥é©Ÿçš„æ—¥èªŒã€‚" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "review<<EOF" >> $GITHUB_OUTPUT
            echo "$REVIEW_TEXT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      # æ­¥é©Ÿ 4ï¼šè™•ç†æ²’æœ‰ç¨‹å¼ç¢¼è®Šæ›´çš„æƒ…æ³
      - name: Handle no code changes
        id: no-changes
        if: steps.get-diff.outputs.diff == ''
        run: |
          echo "review<<EOF" >> $GITHUB_OUTPUT
          echo "æ²’æœ‰æª¢æ¸¬åˆ°ç¨‹å¼ç¢¼è®Šæ›´ï¼Œç„¡éœ€å¯©æŸ¥ã€‚" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # æ­¥é©Ÿ 5ï¼šã€çµ•å°æ­£ç¢ºç‰ˆã€‘å°‡å¯©æŸ¥çµæœç™¼å¸ƒåˆ° Pull Request
      - name: Post or update review comment
        uses: actions/github-script@v7
        # ã€é—œéµä¿®æ­£ã€‘ä½¿ç”¨ env ä¾†å‚³éæˆ‘å€‘è‡ªè¨‚çš„è³‡æ–™
        env:
          REVIEW_OUTPUT: ${{ steps.call-ai.outputs.review }}
          NO_CHANGES_OUTPUT: ${{ steps.no-changes.outputs.review }}
        with:
          script: |
            const botIdentifier = '### ğŸ¤– GLM AI ç¨‹å¼ç¢¼å¯©æŸ¥å ±å‘Š';
            
            // ã€é—œéµä¿®æ­£ã€‘å¾ process.env ä¸­è®€å–ç’°å¢ƒè®Šæ•¸
            const reviewText = process.env.REVIEW_OUTPUT || process.env.NO_CHANGES_OUTPUT || 'å¯©æŸ¥éç¨‹ä¸­ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤ã€‚';

            // å¦‚æœæ²’æœ‰å¯¦è³ªå…§å®¹ï¼Œå°±ä¸ç™¼å¸ƒè©•è«–
            if (!reviewText || reviewText.trim() === '') {
              console.log("å¯©æŸ¥å…§å®¹ç‚ºç©ºï¼Œè·³éç™¼å¸ƒè©•è«–ã€‚");
              return;
            }

            const comments = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const existingComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && comment.body.includes(botIdentifier)
            );

            const newBody = `${botIdentifier}\n\n${reviewText}`;

            if (existingComment) {
              await github.rest.issues.updateComment({
                comment_id: existingComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: newBody
              });
              console.log(`å·²æ›´æ–°è©•è«– #${existingComment.id}`);
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: newBody
              });
              console.log("å·²å‰µå»ºæ–°è©•è«–");
            }

    # æ­¥é©Ÿ 6ï¼šã€æ–°å¢ã€‘å¦‚æœ AI æ‰¹å‡†ï¼Œå‰‡è‡ªå‹•åˆä½µ
      - name: Auto-merge if approved
        uses: actions/github-script@v7
        # åªæœ‰åœ¨ AI å¯©æŸ¥æ­¥é©ŸæˆåŠŸå¾Œæ‰åŸ·è¡Œ
        if: steps.call-ai.outcome == 'success'
        with:
          script: |
            const APPROVAL_KEYWORD = "å¯©æŸ¥é€šéï¼šLGTM";
            const botIdentifier = '### ğŸ¤– GLM AI ç¨‹å¼ç¢¼å¯©æŸ¥å ±å‘Š';

            // 1. ç²å–æ­¤ PR çš„æ‰€æœ‰è©•è«–
            const comments = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            // 2. å°‹æ‰¾æ©Ÿå™¨äººç™¼å¸ƒçš„æœ€æ–°è©•è«–
            const botComment = comments.data
              .filter(comment => comment.user.type === 'Bot' && comment.body.includes(botIdentifier))
              .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))[0];

            // 3. æª¢æŸ¥è©•è«–ä¸­æ˜¯å¦åŒ…å«æ‰¹å‡†é—œéµå­—
            if (botComment && botComment.body.includes(APPROVAL_KEYWORD)) {
              console.log(`æ‰¾åˆ°æ‰¹å‡†é—œéµå­— "${APPROVAL_KEYWORD}"ï¼Œæº–å‚™è‡ªå‹•åˆä½µ...`);

              try {
                // 4. åŸ·è¡Œåˆä½µ
                await github.rest.pulls.merge({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: context.issue.number,
                  // ä½¿ç”¨ 'squash' å¯ä»¥ä¿æŒæ­·å²è¨˜éŒ„ä¹¾æ·¨ï¼Œå°‡æ‰€æœ‰ commit åˆä½µç‚ºä¸€å€‹
                  merge_method: 'squash', 
                  commit_title: `Auto-merge PR #${context.issue.number}: ${context.payload.pull_request.title}`,
                  commit_message: `è‡ªå‹•åˆä½µï¼Œç”± AI å¯©æŸ¥é€šéã€‚\n\n${context.payload.pull_request.body}`
                });
                console.log('âœ… PR å·²æˆåŠŸè‡ªå‹•åˆä½µï¼');
              } catch (error) {
                console.error(`âŒ è‡ªå‹•åˆä½µå¤±æ•—: ${error.message}`);
                // å¦‚æœåˆä½µå¤±æ•—ï¼ˆä¾‹å¦‚ï¼Œæœ‰åˆä½µè¡çªï¼‰ï¼Œå¯ä»¥åœ¨ PR ä¸Šç•™å€‹è¨€
                await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: `âš ï¸ AI å·²æ‰¹å‡†åˆä½µï¼Œä½†è‡ªå‹•åˆä½µå¤±æ•—ã€‚è«‹æª¢æŸ¥æ˜¯å¦æœ‰åˆä½µè¡çªæˆ–å…¶ä»–å•é¡Œã€‚\n\néŒ¯èª¤è¨Šæ¯ï¼š\`${error.message}\``
                });
              }
            } else {
              console.log('AI æœªçµ¦äºˆæ‰¹å‡†ï¼Œè·³éè‡ªå‹•åˆä½µã€‚');
            }
