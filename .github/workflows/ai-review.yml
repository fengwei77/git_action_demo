# æª”æ¡ˆåç¨±ï¼š.github/workflows/ai-review.yml

name: AI Code Review

# è§¸ç™¼æ¢ä»¶ï¼šç•¶æœ‰æ–°çš„æˆ–æ›´æ–°çš„ Pull Request é‡å° main åˆ†æ”¯æ™‚
on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize] # 'synchronize' æ˜¯é—œéµï¼Œå®ƒä»£è¡¨å¾ŒçºŒçš„æäº¤

# å·¥ä½œæµç¨‹æ¬Šé™
permissions:
  pull-requests: write # éœ€è¦å¯«å…¥æ¬Šé™æ‰èƒ½ç™¼å¸ƒè©•è«–
  issues: read         # éœ€è¦è®€å–æ¬Šé™æ‰èƒ½æ‰¾åˆ°èˆŠè©•è«–

jobs:
  ai-review-job:
    runs-on: ubuntu-latest # ä½¿ç”¨æœ€æ–°ç‰ˆçš„ Ubuntu è™›æ“¬æ©Ÿ

    steps:
      # æ­¥é©Ÿ 1ï¼šæª¢å‡ºå°ˆæ¡ˆç¨‹å¼ç¢¼
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # éœ€è¦å®Œæ•´çš„æ­·å²è¨˜éŒ„æ‰èƒ½è¨ˆç®—ç¨‹å¼ç¢¼å·®ç•°

      # æ­¥é©Ÿ 2ï¼šç²å–æœ¬æ¬¡ Pull Request çš„ç¨‹å¼ç¢¼è®Šæ›´å…§å®¹
      - name: Get code diff
        id: get-diff
        run: |
          # è¨ˆç®—ç›®æ¨™åˆ†æ”¯ å’Œä¾†æºåˆ†æ”¯ çš„å·®ç•°
          DIFF=$(git diff --unified=0 origin/${{ github.event.pull_request.base.ref }}...${{ github.event.pull_request.head.ref }})
          # å°‡å·®ç•°å…§å®¹å­˜åˆ°ä¸€å€‹è®Šæ•¸è£¡ï¼Œä¾›å¾ŒçºŒæ­¥é©Ÿä½¿ç”¨
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # æ­¥é©Ÿ 3ï¼šå‘¼å« GLM API é€²è¡Œç¨‹å¼ç¢¼å¯©æŸ¥
      - name: Call GLM API for review
        id: call-ai
        run: |
          # æº–å‚™çµ¦ AI çš„æŒ‡ä»¤ï¼Œé€™å€‹ Prompt å¾ˆé‡è¦ï¼
          PROMPT=$(cat <<EOF
          ä½ æ˜¯ä¸€ä½è³‡æ·±çš„è»Ÿé«”å·¥ç¨‹å¸«ï¼Œè«‹å¯©æŸ¥ä»¥ä¸‹ç¨‹å¼ç¢¼è®Šæ›´ã€‚
          è«‹å¾ä»¥ä¸‹å¹¾é»æä¾›å…·é«”å›é¥‹ï¼š
          1.  **æ½›åœ¨éŒ¯èª¤**ï¼šé‚è¼¯éŒ¯èª¤ã€é‚Šç•Œå•é¡Œç­‰ã€‚
          2.  **ç¨‹å¼ç¢¼å“è³ª**ï¼šå¯è®€æ€§ã€å¯ç¶­è­·æ€§ã€å‘½åè¦ç¯„ã€‚
          3.  **æ•ˆèƒ½å»ºè­°**ï¼šæ˜¯å¦æœ‰æ›´é«˜æ•ˆçš„å¯«æ³•ã€‚
          4.  **å®‰å…¨æ€§**ï¼šæ˜¯å¦æœ‰æ½›åœ¨çš„å®‰å…¨æ¼æ´ã€‚

          è«‹ä½¿ç”¨ Markdown æ ¼å¼å›è¦†ï¼Œä¸¦é‡å°å•é¡Œé»çµ¦å‡ºç¨‹å¼ç¢¼ç‰‡æ®µä½œç‚ºèªªæ˜ã€‚

          --- ç¨‹å¼ç¢¼è®Šæ›´å…§å®¹ ---
          ${{ steps.get-diff.outputs.diff }}
          --- ç¨‹å¼ç¢¼è®Šæ›´çµæŸ ---
          EOF
          )

          # ä½¿ç”¨ curl å‘¼å« GLM API
          RESPONSE=$(curl -s -X POST "https://open.bigmodel.cn/api/paas/v4/chat/completions" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.ZAI_API_KEY }}" \
            -d "{
              \"model\": \"glm-4\",
              \"messages\": [{\"role\": \"user\", \"content\": \"$PROMPT\"}],
              \"temperature\": 0.3
            }")

          # ç”¨ jq å·¥å…·è§£æ JSON å›æ‡‰ï¼Œå–å‡º AI ç”Ÿæˆçš„æ–‡å­—
          REVIEW_TEXT=$(echo "$RESPONSE" | jq -r '.choices[0].message.content')
          
          # å°‡å¯©æŸ¥çµæœå­˜åˆ°è®Šæ•¸è£¡
          echo "review<<EOF" >> $GITHUB_OUTPUT
          echo "$REVIEW_TEXT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # æ­¥é©Ÿ 4ï¼šå°‡å¯©æŸ¥çµæœç™¼å¸ƒåˆ° Pull Request (æœƒæ›´æ–°èˆŠè©•è«–ï¼Œä¿æŒæ•´æ½”)
      - name: Post or update review comment
        uses: actions/github-script@v7
        with:
          script: |
            const reviewOutput = `${{ steps.call-ai.outputs.review }}`;
            const botIdentifier = '### ğŸ¤– GLM AI ç¨‹å¼ç¢¼å¯©æŸ¥å ±å‘Š'; // ç”¨ä¾†è­˜åˆ¥æ©Ÿå™¨äººè©•è«–çš„æ¨™é¡Œ

            if (!reviewOutput || reviewOutput.trim() === '') {
              console.log("AI æ²’æœ‰è¿”å›å¯©æŸ¥å…§å®¹ï¼Œè·³éç™¼å¸ƒè©•è«–ã€‚");
              return;
            }

            // ç²å–æ­¤ PR çš„æ‰€æœ‰è©•è«–
            const comments = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            // å°‹æ‰¾æ©Ÿå™¨äººä¸Šæ¬¡ç™¼å¸ƒçš„è©•è«–
            const existingComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && comment.body.includes(botIdentifier)
            );

            const newBody = `${botIdentifier}\n\n${reviewOutput}`;

            if (existingComment) {
              // å¦‚æœæ‰¾åˆ°äº†èˆŠè©•è«–ï¼Œå°±æ›´æ–°å®ƒ
              await github.rest.issues.updateComment({
                comment_id: existingComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: newBody
              });
              console.log(`å·²æ›´æ–°è©•è«– #${existingComment.id}`);
            } else {
              // å¦‚æœæ²’æ‰¾åˆ°èˆŠè©•è«–ï¼Œå°±å‰µå»ºä¸€æ¢æ–°çš„
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: newBody
              });
              console.log("å·²å‰µå»ºæ–°è©•è«–");
            }
